# STM32F407VE
Тестирую микроконтроллер STM32F407VE на макетке.
(Arm Cortex-M4 with DSP and FPU, 512 Kbyte, 168 MHz, 1 core)

Изначально планировалось использовать как многофункциональное устройство для подключения разных датчиков и контроллеров, для которых дописываешь драйвер и можешь управлять с десктопа через COM порт.

Поскольку на макетке сложно было развести USB, подключение через адаптер USB -> UART. Скорости могут быть > 1 Мбит.

Можно вводить команды в терминале, вроде pytty или YAT, если нужны простые функции вроде переключения пина.

Можно использовать python для более сложных алгоритмов, используя библиотеку pyserial и свою обёртку над ней.

В папке ```Python``` лежит пример такой реализации и инструкция.

## F103 типа BluePill
Реализуя на контроллере F103 типа BluePill на котором разведена USB, 
в конфигурации STM32Cube подключить встроенный драйвер USBCDC, и получим тот же способ обмениваться через COM, однако будут прерывания и переполнения буфера при больших пакетах из-за драйвера.

В интернете есть статьи и сложные самописные драйвера для ускорения приёма через виртуальный comport методом уменьшения буферизации и отказом от двойного буфера.

В проекте использую простую реализацию многозадачности без вытеснения,
в переспективе желательно использовать FreeRTOS.

## Реализованы драйвера для периферии:
- LPH8731 - LCD от Siemens, параллельный интерфейс, TFT,
- BMP280 - датчик атмосферного давления,
- MT6701 - Бесконтактный датчик угла поворота. Используется радиально намагниченный магнит,
- BH1750 - датчик освещённости (люксметр) (неадаптированный код),
- ATH25  - влажность и температура,
- Eeprom I2C,
- Buttons,
- Подсчёт CRC на разные случаи.

## Подключение и управление устройствами
Сейчас реализован протокол управления устройствами по шине i2c. Легко дописать другие протоколы.

Подключая свои устройства на шину i2c можно писать и читать их регистры следующими командами через UART
Используется USART2, выставлять скорость в программе терминала = 1 000 000 bod.
```c
# Адреса устройств на шине i2c
#define I2C_ADDR_24C02  0x52  // AT24C02, (A0 & A2 = GND, A1 = Vcc) I2C address: 0x52 = b1010010 = dec: 82
#define I2C_ADDR_24C32  0x57  // AT24C32,I2C address 0x57, bin: 01010111, dec: 87  (4096 x 8) page 32 bytes
#define I2C_ADDR_INA226 0x40  // INA226, I2C address 0x40, bin: 01000000
#define I2C_ADDR_OLED   0x3C  // OLED,   I2C address 0x3C, bin: 00111100, dec: 60
#define I2C_ADDR_DS3231 0x68  // RTC_DS3231, address 0x68, bin: 01101000, dec: 104
```
## Команды для управления переферией через UART:
```
# Frame data format
'_i2c' 'bus_addr7_hex'  'w/r' 'len_addr[0..2]' 'reg_addr16_hex' 'len_data16_hex' '*data_hex'
```
```
# Command write to 24C02 data 0x0A1B2C to addr 0x10
_i2c 52 w 1 0010 0003 0A1B2C 
    _i2c -> command '_i2c' read/write to i2c bus,
    52 -> device address 0x52,
    w -> write
    1 -> len address register 1 byte,
    0010 -> address register 0x10,
    0003 -> len data '0x03'
    0A1B2C -> data 3 bytes in hex string
```
```
# 24C02
_i2c 52 r 1 0000 0020
_i2c 52 r 0 0000 0010

# 24C32
_i2c 57 w 2 0010 0003 0A1B2C
_i2c 57 r 2 0000 00ff

# DS3231 часы и будильник, но лучше использовать встроенный в stm
_i2c 68 r 1 0000 0013                       DS3231 read all registers
_i2c 68 w 1 0000 0007 00000000000000        DS3231 clear datetime
_i2c 68 w 1 0000 0007 00521800030423        DS3231 write datetime dt[0:6] c:m:h:00:d:m:y
_i2c 68 w 1 0000 0003 005218                DS3231 write time dt[0:2] c:m:h

# INA226 - датчик тока прочитать регистр измерений тока и напряжения
_i2c 40 r 1 0001 0002   INA226 SHUNT_VOLTAGE  sign16 (1 LSB = 2.5 uV) с шунтом R=0.1 Om
_i2c 40 r 1 0002 0002   INA226 BUS_VOLTAGE  unsign16 (1 LSB = 1.25 mV)
```

Что-то может работать не полностью, так как переношу код частями из другово проекта.
Доработать под себя напильником!

### IDE
Использовалась STM32CubeIDE
// Version: 1.15.1
// Build: 21094_20240412_1041
